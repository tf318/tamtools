# TAMtools

TAMtools builds MSB maps between two assemblies, generates hybrid alignments, transforms
such hybrid alignments to synthetic alignments against either of the original
assemblies, and performs a number of related tasks.


Running `tamtools` or `tamtools -h` will give a brief summary of supported commands,
which are currently:

* `tamtools makemap`
* `tamtools hybridize`
* `tamtools partial`
* `tamtools view`
* `tamtools stats`
* `tamtools liftover`
* `tamtools daemon`
* `tamtools client`

A brief overview of each of these commands is given here. More help and usage
information is available on the command line by running `tamtools <command>` for any
supported command.

## tamtools makemap
`tamtools makemap` creates a hybrid reference assembly (in FASTA format) and the corresponding
mapping file for any two reference assemblies:

`tamtools makemap [-o output_dir] <blocklength> <ref_a.fa> <ref_b.fa>`

where `blocklength` is the minimum required size in bases of any MSB, and `ref_a.fa`
and `ref_b.fa` are the paths to the two reference assembly FASTA files. 

If an output
directory is not specified using the `-o` flag, then the hybrid mapping file and hybrid
reference FASTA file will by default be created in the current working directory.

`tamtools makemap` currently makes use of [MUMmer 3](http://mummer.sourceforge.net/ "MUMmer 3.0") to find all maximal unique
matches of length greater than or equal to `blocklength` between the two reference
assemblies. These matches, which may occur on forward or reverse strands, determine
coordinates for the resulting MSBs. To run `tamtools makemap`, the location of a 64-bit
`mummer` binary must be added to the `PATH` environment variable.


## tamtools hybridize
tamtools hybridize is a fully automatic workflow which converts an original reference
alignment to a full hybrid MSB alignment. The hybrid alignment can be used
to subsequently synthesize an alignment against either of the two original reference
assemblies. Its usage is shown below:

`tamtools hybridize [-i ref_aln.bam] <output_dir> <map_file> <ref_assembly_id>`

where `output_dir` is the directory into which the new hybrid alignment file and any
unmapped reads against either original reference will be stored, `map_file` is the path to
the mapping file generated by `tamtools makemap`, and `ref_assembly_id` is the ID (*1* or
*2*) of the assembly against which the original alignment was made. (Note that the IDs
for both reference assemblies are defined in the mapping file, and can be determined
using `tamtools stat`s). If an alignment file is not specified using the `-i` flag, then the
tool will read from `stdin`. For example:

    # specify an input aligment file:
    tamtools hybridize -i ref1_aln.bam output_dir/ msb.map 1
    
    # or redirect stdout to tamtools:
    cat ref1_aln.bam | tamtools hybridize output_dir/ msb.map 1
    
    # or redirect stdin to tamtools:
    tamtools hybridize output_dir/ msb.map 1 < ref1_aln.bam
    
This command effectively performs the following workflow:

1. Creates a partial hybrid alignment against the hybrid reference (as per `tamtools partial` command;
2. Aligns any "private" reads to the second reference assembly, then creates a partial hybrid alignment for these results;
3. Aligns any originally unmapped reads to the second reference assembly, then
creates a partial hybrid alignment for these results;
4. Merges the three partial hybrid alignments into a single ’full’ hybrid alignment.

Reads that are unmapped with respect to each of the two original reference assemblies
are stored separately from the hybrid alignment. Users may wish to merge these
unmapped reads with any results obtained from `tamtools view`.

The alignment steps (2 and 3 above) currently make use of the [BWA Aligner](http://bio-bwa.sourceforge.net/ "BWA Aligner"). To
run `tamtools hybridize`, the location of a `bwa` binary (with *bwa mem* support) must be
added to the `PATH` environment variable.
Should a user wish to employ an alternate aligner, then the `tamtools partial` command
can be used instead (and a workflow for the above steps would also need to be manually
implemented).

## tamtools partial
`tamtools partial` produces a "partial" hybrid alignment, which means only the original
mapped reads are processed, and are remapped to MSB regions or to private regions
specific to the original assembly (and not to a second assembly).

A partial hybrid alignment is, by itself, of limited utility – but it does allow a user build
a full hybrid alignment while using a different aligner (i.e. not the default BWA) to
realign the remaining unmapped reads and any "private" reads from the first reference
to the second reference. In general, however, for a "full" hybrid alignment it is simplest
to use the `tamtools hybridize` command, which automates the entire process.

`tamtools partial` is used as in the following examples:

	# convert all mappable reads to a hybrid alignment, and ignore unmapped reads:
	tamtools partial -i ref1_aln.bam -o hybrid_alignment.bam msb.map 1

	# or convert all mappable reads to a hybrid alignment, and save unmapped reads:
	tamtools partial -i ref1_aln.bam -o hybrid_alignment.bam -u unmap.bam msb.map 1

The partial command can also read from to `stdin` and/or write to `stdout`; for example:

	# redirect stdout to tamtools, and specify output file:
	cat ref1_aln.bam | tamtools partial -o hybrid_alignment.bam msb.map 1

	# or redirect stdout to tamtools, and redirect stdout to file:
	cat ref1_aln.bam | tamtools partial msb.map 1 > hybrid_alignment.bam

	# or specify input alignment file, and redirect stdout to file:
	tamtools partial -i ref1_aln.bam msb.map 1 > hybrid_alignment.bam

	# or redirect stdin to tamtools, and specify output file:
	tamtools partial -o hybrid_alignment.bam msb.map 1 < ref1_aln.bam

## tamtools view

`tamtools view` uses a hybrid alignment to synthesize an alignment against the original
or new reference. It will produce an alignment in the same format as the hybrid
alignment (i.e. SAM, BAM or CRAM). For example:

	# Synthesize an alignment against the first assembly:
	tamtools view -i hybrid_alignment.bam -o ref1_aln.bam msb.map 1
	
	# Synthesize an alignment against the second assembly:
	tamtools view -i hybrid_alignment.bam -o ref2_aln.bam msb.map 2

As with most tamtools commands, tamtools view can also read from `stdin` and/or
write to `stdout`:

	# redirect stdout to tamtools, and specify output file:
	cat hybrid_alignment.bam | tamtools view -o ref1_aln.bam msb.map 1

	# or redirect stdout to tamtools, and redirect stdout to file:
	cat hybrid_alignment.bam | tamtools view msb.map 1 > ref1_aln.bam

	# or specify input file, and redirect stdout to file:
	tamtools view -i hybrid_alignment.bam msb.map 1 > ref1_aln.bam

## tamtools stats
`tamtools stats` shows information about an MSB map, including the IDs (*1* or *2*) of
each of the original reference assemblies, the sizes and MSB proportions of each contig
in each of these assemblies, and some summary statistics including the MSB N50. It requires as a parameter
the path to the hybrid map:

    tamtools stats human_h37_h37_1000/map/msb.map


## tamtools liftover
`tamtools liftover` emulates the behaviour of the [https://genome.ucsc.edu/util.html](https://genome.ucsc.edu/util.html "UCSC liftOver") tool, but using the
MSB mapping file generated with `tamtools makemap` instead of a UCSC chain file.
This allows annotations to be translated from one assembly to the other. Annotations
must be in BED format. Example usage is as follows:

	# liftover to output.bed and write unmapped to separate file:
	tamtools liftover msb.map 2 h38snp_chr_1.bed output.bed unmapped.bed

	# use heuristics to translate names between GRC/NCBI/USCS format (e.g
	# chr1, chrX, and chrM to 1, X and MT respectively):
	tamtools liftover -t msb.map 1 h37snp_chr_1.bed output.bed unmapped.bed

## tamtools daemon
`tamtools daemon` launches an HTTP-based coordinate remapping service, allowing
translation of coordinates to or from a hybrid reference (see also `tamtools client`).
By default, the service listens on port 2003 of the loopback address:

	# listen on 127.0.0.1:2003
	tamtools daemon msb.map

	# listen on 127.0.0.1:8000
	tamtools daemon -p 8000 msb.map

	# quiet mode - do not log requests to console:
	tamtools daemon -q msb.map

## tamtools client
`tamtools client` is a simple command line client that queries an HTTP service (see
`tamtools daemon`) to remap coordinates to/from a hybrid reference or between the two
original assemblies. Usage is as follows:

	# convert a ref assembly 2 coordinate to a hybrid coordinate:
	tamtools client localhost 2003 forward 2 chr1 1524810 1524830 -
	# returns: (’MSB_61:178400’, 72523, 72543, ’-’)

	# convert a hybrid coordinate to a ref assembly 2 coordinate:
	tamtools client localhost 2003 backward 2 MSB_61:178400 72523 72543 -
	# returns: (’chr1’, 1524810, 1524830, ’-’)

	# convert a hybrid coordinate to a ref assembly 1 coordinate:
	tamtools client localhost 2003 backward 1 MSB_61:178400 72523 72543 -
	# returns: (’1’, 1460190, 1460210, ’-’)

	# convert a ref assembly 2 to a ref assembly 1 coordinate:
	tamtools client localhost 2003 translate 2 chr1 1524810 1524830 -
	# returns (’1’, 1460190, 1460210, ’-’)

	# convert a ref assembly 1 to a ref assembly 2 coordinate:
	tamtools client localhost 2003 translate 1 1 1460190 1460210 -
	# returns (’chr1’, 1524810, 1524830, ’-’)
